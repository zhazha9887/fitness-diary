<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ëé´Ëò≠Ëø™ÂÅ•Ë∫´Êó•Ë™å</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÂÅ•Ë∫´Êó•Ë™å">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2964/2964514.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
    
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F7F5F0;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        /* ËºâÂÖ•ÂãïÁï´ */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <div id="error-message" style="display:none; color:red; padding:20px; font-weight:bold;"></div>

    <script type="text/babel">
        // --- ÈåØË™§ËôïÁêÜ ---
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').innerText = 'ÁôºÁîüÈåØË™§: ' + message;
        };

        // --- ÂæûÂÖ®ÂüüËÆäÊï∏Áç≤ÂèñÂ∫´ ---
        const { useState, useEffect, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = window.Recharts;
        const { Calendar, Activity, Waves, Dumbbell, Save, ChevronLeft, ChevronRight, X, Plus, TrendingUp } = lucide;

        // --- Ë®≠ÂÆöËàáÂ∏∏Êï∏ ---
        const METS = { 'ÈáçË®ì': 5.0, 'ÊúâÊ∞ß': 7.0, 'Ê∏∏Ê≥≥': 8.0, 'ÁëúÁèà': 3.0, 'ÂÖ∂‰ªñ': 4.0 };

        const App = () => {
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [records, setRecords] = useState({});
            const [showModal, setShowModal] = useState(false);
            const [view, setView] = useState('calendar');
            
            // Ë°®ÂñÆÁãÄÊÖã
            const [inputType, setInputType] = useState('ÈáçË®ì');
            const [inputContent, setInputContent] = useState('');
            const [inputTime, setInputTime] = useState('');
            const [inputWeight, setInputWeight] = useState('');

            // ÂàùÂßãÂåñËÆÄÂèñË≥áÊñô
            useEffect(() => {
                try {
                    const savedData = localStorage.getItem('fitness_data_v1');
                    if (savedData) setRecords(JSON.parse(savedData));
                    const lastWeight = localStorage.getItem('last_weight');
                    if (lastWeight) setInputWeight(lastWeight);
                } catch (e) {
                    console.error("ËÆÄÂèñË≥áÊñôÂ§±Êïó", e);
                }
            }, []);

            // Â≠òÊ™î
            const handleSave = () => {
                if(!inputContent) return alert("Ë´ãËº∏ÂÖ•ÂÖßÂÆπÔºÅ");
                
                const dateKey = selectedDate.toISOString().split('T')[0];
                let calories = 0;
                if (inputWeight && inputTime) {
                    const met = METS[inputType] || 4.0;
                    calories = Math.round(met * parseFloat(inputWeight) * (parseFloat(inputTime) / 60));
                }

                const newRecord = {
                    id: Date.now(),
                    type: inputType,
                    content: inputContent,
                    time: inputTime,
                    weight: inputWeight,
                    calories: calories
                };

                const updatedRecords = { ...records, [dateKey]: [...(records[dateKey] || []), newRecord] };
                setRecords(updatedRecords);
                localStorage.setItem('fitness_data_v1', JSON.stringify(updatedRecords));
                if (inputWeight) localStorage.setItem('last_weight', inputWeight);
                
                setShowModal(false);
                setInputContent('');
                setInputTime('');
            };

            const handleDelete = (dateKey, id) => {
                const updatedRecords = { ...records, [dateKey]: records[dateKey].filter(r => r.id !== id) };
                setRecords(updatedRecords);
                localStorage.setItem('fitness_data_v1', JSON.stringify(updatedRecords));
            };

            const addToCalendar = (record) => {
                const title = `üèãÔ∏è ${record.type}: ${record.content}`;
                const dateStr = selectedDate.toISOString().split('T')[0].replace(/-/g, '');
                const details = `ÊôÇÈñì: ${record.time}ÂàÜÈêò\nÊ∂àËÄó: ${record.calories} kcal`;
                const url = `data:text/calendar;charset=utf8,BEGIN:VCALENDAR%0AVERSION:2.0%0ABEGIN:VEVENT%0ADTSTART:${dateStr}%0ADTEND:${dateStr}%0ASUMMARY:${title}%0ADESCRIPTION:${details}%0AEND:VEVENT%0AEND:VCALENDAR`;
                window.open(url);
            };

            // Êó•ÊõÜÊ∏≤Êüì
            const renderCalendar = () => {
                const year = selectedDate.getFullYear();
                const month = selectedDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const days = [];

                for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-24"></div>);

                for (let d = 1; d <= daysInMonth; d++) {
                    const currentString = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dayRecords = records[currentString] || [];
                    const isSelected = selectedDate.getDate() === d && selectedDate.getMonth() === month;
                    
                    days.push(
                        <div key={d} onClick={() => setSelectedDate(new Date(year, month, d))}
                             className={`h-24 border-t border-l border-gray-200 p-1 relative flex flex-col items-center transition-all ${isSelected ? 'bg-[#E8E0D5]/50' : 'bg-white'}`}>
                            <span className={`text-sm mb-1 ${isSelected ? 'font-bold text-[#8E8070]' : 'text-gray-500'}`}>{d}</span>
                            <div className="flex flex-wrap justify-center gap-1 w-full">
                                {dayRecords.map((r, i) => (
                                    <div key={i} className="w-2 h-2 rounded-full" 
                                         style={{backgroundColor: r.type==='ÊúâÊ∞ß'?'#739072':r.type==='Ê∏∏Ê≥≥'?'#8CABBE':'#6B7280'}}></div>
                                ))}
                            </div>
                            {dayRecords.length > 0 && <span className="absolute bottom-1 right-1 text-[10px] text-gray-400">{dayRecords.reduce((a,c)=>a+(c.calories||0),0)}</span>}
                        </div>
                    );
                }
                return days;
            };

            const currentKey = selectedDate.toISOString().split('T')[0];
            const currentRecords = records[currentKey] || [];
            
            // ÂúñË°®Ë≥áÊñô
            const chartData = useMemo(() => {
                return Object.keys(records).sort().map(k => {
                   const w = records[k].find(r => r.weight);
                   return w ? { date: k.slice(5), weight: parseFloat(w.weight) } : null;
                }).filter(Boolean).slice(-10);
            }, [records]);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#F7F5F0] pb-20 fade-in">
                    {/* È†ÇÈÉ®Â∞éËà™ */}
                    <div className="pt-12 pb-4 px-6 flex justify-between items-center bg-white sticky top-0 z-10 shadow-sm">
                        <h1 className="text-xl font-bold text-[#5C5C5C]">{selectedDate.getFullYear()} Âπ¥ {selectedDate.getMonth() + 1} Êúà</h1>
                        <button onClick={() => setView(view === 'calendar' ? 'stats' : 'calendar')} className="p-2 rounded-full bg-gray-100">
                            {view === 'calendar' ? <TrendingUp size={20} color="#8E8070"/> : <Calendar size={20} color="#8E8070"/>}
                        </button>
                    </div>

                    <div className="p-4">
                        {view === 'calendar' ? (
                            <>
                                <div className="grid grid-cols-7 text-center mb-2 text-xs text-gray-400">
                                    {['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'].map(d=><div key={d}>{d}</div>)}
                                </div>
                                <div className="grid grid-cols-7 bg-white rounded-xl shadow-sm overflow-hidden border-r border-b border-gray-200">
                                    {renderCalendar()}
                                </div>

                                {/* Ë©≥Á¥∞Ë≥áÊñôÂçÄ */}
                                <div className="mt-6">
                                    <div className="flex justify-between items-center mb-3 px-1">
                                        <h3 className="text-[#8E8070] font-medium">{selectedDate.getMonth()+1}/{selectedDate.getDate()} Á¥ÄÈåÑ</h3>
                                        <button onClick={() => setShowModal(true)} className="bg-[#8E8070] text-white px-3 py-1.5 rounded-full text-sm flex items-center gap-1 shadow">
                                            <Plus size={16}/> Êñ∞Â¢û
                                        </button>
                                    </div>
                                    <div className="space-y-3">
                                        {currentRecords.map(r => (
                                            <div key={r.id} className="bg-white p-3 rounded-xl shadow-sm border-l-4 border-[#8E8070] relative">
                                                <div className="flex justify-between">
                                                    <div>
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="text-xs px-2 py-0.5 rounded text-white bg-gray-500"
                                                                  style={{backgroundColor: r.type==='ÊúâÊ∞ß'?'#739072':r.type==='Ê∏∏Ê≥≥'?'#8CABBE':'#6B7280'}}>
                                                                {r.type}
                                                            </span>
                                                            <span className="text-gray-700 font-medium">{r.content}</span>
                                                        </div>
                                                        <div className="text-xs text-gray-400 space-x-2">
                                                            <span>‚è± {r.time}min</span>
                                                            <span>üî• {r.calories}kcal</span>
                                                            {r.weight && <span>‚öñÔ∏è {r.weight}kg</span>}
                                                        </div>
                                                    </div>
                                                    <button onClick={() => handleDelete(currentKey, r.id)} className="text-gray-300 p-1"><X size={16}/></button>
                                                </div>
                                                <button onClick={() => addToCalendar(r)} className="absolute bottom-2 right-2 bg-gray-50 text-[#8CABBE] text-[10px] px-2 py-1 rounded-full border border-gray-100">
                                                    üìÖ ÂêåÊ≠•
                                                </button>
                                            </div>
                                        ))}
                                        {currentRecords.length === 0 && <div className="text-center text-gray-300 py-6 border border-dashed rounded-xl">Â∞öÁÑ°Á¥ÄÈåÑ</div>}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="bg-white p-6 rounded-2xl shadow-sm">
                                <h3 className="text-gray-600 font-bold mb-4">È´îÈáçË∂®Âã¢</h3>
                                <div className="h-64">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart data={chartData}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false}/>
                                            <XAxis dataKey="date" tick={{fontSize:12}} axisLine={false} tickLine={false}/>
                                            <YAxis domain={['auto','auto']} width={30} tick={{fontSize:12}} axisLine={false} tickLine={false}/>
                                            <Tooltip/>
                                            <Line type="monotone" dataKey="weight" stroke="#8E8070" strokeWidth={3} dot={{fill:'#8E8070'}}/>
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modal */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowModal(false)}>
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 space-y-4" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-gray-700">Êñ∞Â¢ûÁ¥ÄÈåÑ</h3>
                                <div className="flex gap-2">
                                    {['ÈáçË®ì','ÊúâÊ∞ß','Ê∏∏Ê≥≥','ÁëúÁèà'].map(t => (
                                        <button key={t} onClick={() => setInputType(t)} 
                                            className={`flex-1 py-2 rounded text-sm ${inputType===t?'bg-[#8E8070] text-white':'bg-gray-100 text-gray-600'}`}>{t}</button>
                                    ))}
                                </div>
                                <input type="text" value={inputContent} onChange={e=>setInputContent(e.target.value)} className="w-full bg-gray-50 border p-3 rounded-lg" placeholder="ÂÖßÂÆπ (Â¶Ç: Ê∑±Ëπ≤ 50kg)"/>
                                <div className="grid grid-cols-2 gap-4">
                                    <input type="number" value={inputTime} onChange={e=>setInputTime(e.target.value)} className="bg-gray-50 border p-3 rounded-lg" placeholder="ÊôÇÈñì(ÂàÜ)"/>
                                    <input type="number" value={inputWeight} onChange={e=>setInputWeight(e.target.value)} className="bg-gray-50 border p-3 rounded-lg" placeholder="È´îÈáç(kg)"/>
                                </div>
                                <button onClick={handleSave} className="w-full bg-[#8E8070] text-white py-3 rounded-xl font-bold shadow-lg">ÂÑ≤Â≠ò</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
