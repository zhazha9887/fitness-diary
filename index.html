<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è«è˜­è¿ªå¥èº«æ—¥èªŒ</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥èº«æ—¥èªŒ">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2964/2964514.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F7F5F0; /* å¥¶èŒ¶è‰²èƒŒæ™¯ */
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        /* è‡ªå®šç¾©é¡è‰²è®Šæ•¸ */
        :root {
            --color-bg: #F7F5F0;
            --color-card: #FFFFFF;
            --color-text-primary: #5C5C5C;
            --color-text-secondary: #8C8C8C;
            --color-accent: #8E8070; /* æš–æ£•è‰² */
            --color-dot-strength: #6B7280; /* æ·±ç° (é‡è¨“) */
            --color-dot-cardio: #739072; /* è«è˜­è¿ªç¶  (æœ‰æ°§) */
            --color-dot-swim: #8CABBE; /* è«è˜­è¿ªè— (æ¸¸æ³³) */
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { Calendar, Activity, Waves, Dumbbell, Save, ChevronLeft, ChevronRight, X, Plus, TrendingUp, Share } = lucide;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

        // --- è¨­å®šå€ ---
        const GOOGLE_FORM_ACTION_URL = ""; // å¦‚æœä½ è¦è‡ªå‹•ä¸Šå‚³ï¼Œä¹‹å¾Œé€™è£¡å¡«å…¥è¡¨å–®ç¶²å€
        
        // é‹å‹•å¼·åº¦ä¿‚æ•¸ (METs)
        const METS = {
            'é‡è¨“': 5.0, // ä¸­é«˜å¼·åº¦é‡è¨“
            'æœ‰æ°§': 7.0, // æ…¢è·‘/é«˜å¼·åº¦æœ‰æ°§
            'æ¸¸æ³³': 8.0, // è‡ªç”±å¼ä¸­ç­‰é€Ÿåº¦
            'ç‘œçˆ': 3.0,
            'å…¶ä»–': 4.0
        };

        const App = () => {
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [records, setRecords] = useState({}); // å„²å­˜æ‰€æœ‰çš„ç´€éŒ„
            const [showModal, setShowModal] = useState(false);
            const [view, setView] = useState('calendar'); // calendar, stats
            
            // è¡¨å–®è¼¸å…¥ç‹€æ…‹
            const [inputType, setInputType] = useState('é‡è¨“');
            const [inputContent, setInputContent] = useState('');
            const [inputTime, setInputTime] = useState(''); // åˆ†é˜
            const [inputWeight, setInputWeight] = useState('');

            // åˆå§‹åŒ–ï¼šå¾ LocalStorage è®€å–è³‡æ–™
            useEffect(() => {
                const savedData = localStorage.getItem('fitness_data_v1');
                if (savedData) {
                    setRecords(JSON.parse(savedData));
                }
                // å˜—è©¦è®€å–æœ€å¾Œä¸€æ¬¡é«”é‡
                const lastWeight = localStorage.getItem('last_weight');
                if (lastWeight) setInputWeight(lastWeight);
            }, []);

            // å„²å­˜è³‡æ–™
            const handleSave = () => {
                const dateKey = selectedDate.toISOString().split('T')[0];
                
                // è¨ˆç®—å¡è·¯é‡Œ
                let calories = 0;
                if (inputWeight && inputTime) {
                    const met = METS[inputType] || 4.0;
                    const hours = parseFloat(inputTime) / 60;
                    calories = Math.round(met * parseFloat(inputWeight) * hours);
                }

                const newRecord = {
                    id: Date.now(),
                    type: inputType,
                    content: inputContent,
                    time: inputTime,
                    weight: inputWeight,
                    calories: calories
                };

                const updatedRecords = {
                    ...records,
                    [dateKey]: [...(records[dateKey] || []), newRecord]
                };

                setRecords(updatedRecords);
                localStorage.setItem('fitness_data_v1', JSON.stringify(updatedRecords));
                if (inputWeight) localStorage.setItem('last_weight', inputWeight);

                // å¦‚æœæœ‰è¨­å®š Google Formï¼Œé€™è£¡æœƒè‡ªå‹•ç™¼é€ (ç›®å‰å…ˆç•™ç©º)
                
                setShowModal(false);
                // æ¸…ç©ºè¼¸å…¥
                setInputContent('');
                setInputTime('');
            };

            const handleDelete = (dateKey, id) => {
                const updatedDayRecords = records[dateKey].filter(r => r.id !== id);
                const updatedRecords = { ...records, [dateKey]: updatedDayRecords };
                setRecords(updatedRecords);
                localStorage.setItem('fitness_data_v1', JSON.stringify(updatedRecords));
            };

            // åŠ å…¥è¡Œäº‹æ›†åŠŸèƒ½
            const addToCalendar = (record) => {
                const title = `ğŸ‹ï¸ ${record.type}: ${record.content}`;
                const startDate = selectedDate.toISOString().split('T')[0].replace(/-/g, '');
                const endDate = startDate;
                const details = `æ™‚é–“: ${record.time}åˆ†é˜\næ¶ˆè€—: ${record.calories} kcal\né«”é‡: ${record.weight}kg`;
                const url = `data:text/calendar;charset=utf8,BEGIN:VCALENDAR%0AVERSION:2.0%0ABEGIN:VEVENT%0ADTSTART:${startDate}%0ADTEND:${endDate}%0ASUMMARY:${title}%0ADESCRIPTION:${details}%0AEND:VEVENT%0AEND:VCALENDAR`;
                
                window.open(url);
            };

            // ç”¢ç”Ÿæœˆæ›†æ ¼å­
            const renderCalendarDays = () => {
                const year = selectedDate.getFullYear();
                const month = selectedDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const days = [];
                for (let i = 0; i < firstDay; i++) {
                    days.push(<div key={`empty-${i}`} className="h-24"></div>);
                }

                for (let d = 1; d <= daysInMonth; d++) {
                    const currentString = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dayRecords = records[currentString] || [];
                    const isToday = new Date().toDateString() === new Date(year, month, d).toDateString();
                    const isSelected = selectedDate.getDate() === d && selectedDate.getMonth() === month;

                    days.push(
                        <div 
                            key={d} 
                            onClick={() => setSelectedDate(new Date(year, month, d))}
                            className={`h-24 border-t border-l border-[#E5E5E5] p-1 relative flex flex-col items-center transition-all
                                ${isSelected ? 'bg-[#E8E0D5] bg-opacity-30' : 'bg-white'}
                                ${isToday ? 'font-bold text-[#8E8070]' : 'text-[#5C5C5C]'}
                            `}
                        >
                            <span className="text-sm mb-1">{d}</span>
                            <div className="flex flex-wrap justify-center gap-1 w-full">
                                {dayRecords.map((r, idx) => {
                                    let color = '#6B7280';
                                    if(r.type === 'æœ‰æ°§') color = '#739072';
                                    if(r.type === 'æ¸¸æ³³') color = '#8CABBE';
                                    return (
                                        <div key={idx} className="w-2 h-2 rounded-full" style={{backgroundColor: color}}></div>
                                    )
                                })}
                            </div>
                            {dayRecords.length > 0 && (
                                <span className="absolute bottom-1 right-1 text-[10px] text-gray-400">
                                    {dayRecords.reduce((acc, cur) => acc + (cur.calories || 0), 0)}
                                </span>
                            )}
                        </div>
                    );
                }
                return days;
            };

            // çµ±è¨ˆåœ–è¡¨æ•¸æ“šæº–å‚™
            const chartData = useMemo(() => {
                const data = [];
                const sortedKeys = Object.keys(records).sort();
                sortedKeys.forEach(key => {
                    const dayRecs = records[key];
                    // æ‰¾ç•¶å¤©æœ€å¾Œä¸€ç­†é«”é‡
                    const weightRec = dayRecs.find(r => r.weight);
                    if (weightRec) {
                        data.push({ date: key.slice(5), weight: parseFloat(weightRec.weight) });
                    }
                });
                return data.slice(-10); // åªå–æœ€è¿‘ 10 ç­†
            }, [records]);

            // ç•¶å‰é¸ä¸­æ—¥æœŸçš„ç´€éŒ„
            const currentKey = selectedDate.toISOString().split('T')[0];
            const currentRecords = records[currentKey] || [];

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#F7F5F0] pb-20 relative shadow-2xl overflow-hidden">
                    
                    {/* é ‚éƒ¨æ¨™é¡Œ */}
                    <div className="pt-12 pb-4 px-6 flex justify-between items-center bg-white shadow-sm sticky top-0 z-10">
                        <h1 className="text-2xl font-bold text-[#5C5C5C] tracking-wide">
                            {selectedDate.getFullYear()} å¹´ {selectedDate.getMonth() + 1} æœˆ
                        </h1>
                        <div className="flex gap-2">
                            <button onClick={() => setView(view === 'calendar' ? 'stats' : 'calendar')} className="p-2 rounded-full bg-[#F7F5F0] text-[#8E8070]">
                                {view === 'calendar' ? <TrendingUp size={20}/> : <Calendar size={20}/>}
                            </button>
                        </div>
                    </div>

                    {/* ä¸»è¦å…§å®¹å€ */}
                    <div className="p-4">
                        {view === 'calendar' ? (
                            <>
                                {/* æ˜ŸæœŸæ¨™é ­ */}
                                <div className="grid grid-cols-7 text-center mb-2 text-[#8C8C8C] text-xs">
                                    {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => <div key={d}>{d}</div>)}
                                </div>
                                {/* æ—¥æ›†æœ¬é«” */}
                                <div className="grid grid-cols-7 bg-white rounded-xl overflow-hidden shadow-sm border-r border-b border-[#E5E5E5]">
                                    {renderCalendarDays()}
                                </div>

                                {/* ç•¶æ—¥è©³ç´°è³‡è¨Šå¡ç‰‡ */}
                                <div className="mt-6">
                                    <div className="flex justify-between items-end mb-2 px-2">
                                        <h3 className="text-[#8E8070] font-medium text-lg">
                                            {selectedDate.getMonth() + 1}/{selectedDate.getDate()} è¨“ç·´ç´€éŒ„
                                        </h3>
                                        <button 
                                            onClick={() => setShowModal(true)}
                                            className="bg-[#8E8070] text-white px-4 py-2 rounded-full text-sm shadow-md flex items-center gap-1 active:scale-95 transition-transform"
                                        >
                                            <Plus size={16}/> æ–°å¢
                                        </button>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        {currentRecords.length === 0 ? (
                                            <div className="text-center text-gray-400 py-8 bg-white rounded-xl border border-dashed border-gray-300">
                                                ä»Šå¤©é‚„æ²’æœ‰ç´€éŒ„ï¼Œå‹•èµ·ä¾†ï¼ğŸ’ª
                                            </div>
                                        ) : (
                                            currentRecords.map((r) => (
                                                <div key={r.id} className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-[#8E8070] relative group">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <div className="flex items-center gap-2">
                                                                <span className={`px-2 py-0.5 rounded text-xs text-white
                                                                    ${r.type === 'é‡è¨“' ? 'bg-[#6B7280]' : r.type === 'æœ‰æ°§' ? 'bg-[#739072]' : 'bg-[#8CABBE]'}
                                                                `}>{r.type}</span>
                                                                <span className="font-medium text-[#5C5C5C]">{r.content}</span>
                                                            </div>
                                                            <div className="text-xs text-gray-400 mt-1 flex gap-3">
                                                                <span>â± {r.time} min</span>
                                                                <span>ğŸ”¥ {r.calories} kcal</span>
                                                                {r.weight && <span>âš–ï¸ {r.weight} kg</span>}
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => handleDelete(currentKey, r.id)}
                                                            className="text-gray-300 hover:text-red-400 p-1"
                                                        >
                                                            <X size={16}/>
                                                        </button>
                                                    </div>
                                                    {/* åŠ å…¥è¡Œäº‹æ›†æŒ‰éˆ• (å°å°çš„) */}
                                                    <button 
                                                        onClick={() => addToCalendar(r)}
                                                        className="absolute bottom-2 right-2 text-[#8CABBE] hover:text-[#5C5C5C] text-xs flex items-center gap-1 bg-gray-50 px-2 py-1 rounded-full"
                                                    >
                                                        ğŸ“… åŒæ­¥
                                                    </button>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </>
                        ) : (
                            /* åœ–è¡¨æ¨¡å¼ */
                            <div className="bg-white p-6 rounded-2xl shadow-sm">
                                <h3 className="text-[#5C5C5C] font-bold mb-6">é«”é‡è¶¨å‹¢åœ– (æœ€è¿‘10ç­†)</h3>
                                {chartData.length > 1 ? (
                                    <div className="h-64 w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <LineChart data={chartData}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E5E5E5"/>
                                                <XAxis dataKey="date" tick={{fontSize: 12, fill: '#8C8C8C'}} axisLine={false} tickLine={false}/>
                                                <YAxis domain={['auto', 'auto']} tick={{fontSize: 12, fill: '#8C8C8C'}} axisLine={false} tickLine={false} width={30}/>
                                                <Tooltip contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)'}}/>
                                                <Line type="monotone" dataKey="weight" stroke="#8E8070" strokeWidth={3} dot={{fill: '#8E8070', strokeWidth: 2}} activeDot={{r: 6}} />
                                            </LineChart>
                                        </ResponsiveContainer>
                                    </div>
                                ) : (
                                    <div className="text-center text-gray-400 py-10">
                                        éœ€è¦æ›´å¤šæ•¸æ“šæ‰èƒ½é¡¯ç¤ºåœ–è¡¨ ğŸ“Š
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* æ–°å¢ç´€éŒ„ Modal (å½ˆè·³è¦–çª—) */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowModal(false)}>
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 space-y-4 animate-slide-up" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="text-lg font-bold text-[#5C5C5C]">æ–°å¢ç´€éŒ„</h3>
                                    <button onClick={() => setShowModal(false)}><X size={24} className="text-gray-400"/></button>
                                </div>
                                
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">é‹å‹•é¡å‹</label>
                                    <div className="flex gap-2">
                                        {['é‡è¨“', 'æœ‰æ°§', 'æ¸¸æ³³', 'ç‘œçˆ'].map(t => (
                                            <button 
                                                key={t}
                                                onClick={() => setInputType(t)}
                                                className={`flex-1 py-2 rounded-lg text-sm transition-colors
                                                    ${inputType === t ? 'bg-[#8E8070] text-white shadow-md' : 'bg-gray-100 text-gray-600'}
                                                `}
                                            >
                                                {t}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">è©³ç´°å…§å®¹ (ä¾‹å¦‚: æ·±è¹² 50kg)</label>
                                    <input 
                                        type="text" 
                                        value={inputContent}
                                        onChange={e => setInputContent(e.target.value)}
                                        className="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-[#5C5C5C] focus:outline-none focus:ring-2 focus:ring-[#8E8070]"
                                        placeholder="è¼¸å…¥èª²è¡¨..."
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">æ™‚é–“ (åˆ†é˜)</label>
                                        <input 
                                            type="number" 
                                            value={inputTime}
                                            onChange={e => setInputTime(e.target.value)}
                                            className="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-[#5C5C5C]"
                                            placeholder="60"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">ä»Šæ—¥é«”é‡ (kg)</label>
                                        <input 
                                            type="number" 
                                            value={inputWeight}
                                            onChange={e => setInputWeight(e.target.value)}
                                            className="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-[#5C5C5C]"
                                            placeholder="60.5"
                                        />
                                    </div>
                                </div>

                                <button 
                                    onClick={handleSave}
                                    className="w-full bg-[#8E8070] text-white py-3 rounded-xl font-bold shadow-lg mt-4 active:scale-95 transition-transform"
                                >
                                    å„²å­˜ç´€éŒ„
                                </button>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <script>
        // è¨»å†Š Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>
